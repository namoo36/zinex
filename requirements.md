# Requirements (MVP 기준)
## 주식 거래소 백엔드 요구사항 정의서

### 1. 문서 목적
- MVP 단계에서 **무엇을 구현해야 하는지**를 기능/비기능 요구사항으로 명확히 정의한다.
- 이후 Phase 확장( Postgres/Mongo/Elasticsearch/튜닝/덤프분석 )을 위한 **확장 포인트**를 요구사항에 함께 기록한다.

### 2. 범위 (Scope)
- **MVP 기술 스택**: Java + Spring Boot + MySQL + Redis
- **인증 방식**: Spring Security + JWT
- **핵심 도메인**: 회원/계좌(예수금)/종목/주문/체결/잔고

### 3. 용어 정의
- **예수금(Deposit)**: 사용자가 원화를 입금하여 확보한 현금성 잔액
- **Hold 금액**: 매수 주문 시 “주문 가능 금액”에서 즉시 차감(예약)되는 금액
- **주문 가능 금액(Available)**: 예수금 - Hold 금액 (계산값)
- **체결(Fill)**: 주문이 매칭되어 거래가 성사된 상태

### 4. 기능 요구사항 (Functional Requirements)

#### 4.1 회원/인증
- **FR-AUTH-001**: 회원가입(이메일/비밀번호) 기능을 제공해야 한다.
- **FR-AUTH-002**: 로그인 시 JWT Access Token(및 Refresh Token 옵션)을 발급해야 한다.
- **FR-AUTH-003**: 인증이 필요한 API는 JWT 검증을 통해 접근을 제어해야 한다.
- **FR-AUTH-004**: 로그아웃(토큰 무효화 정책 포함) 기능을 제공해야 한다.  
  - MVP에서는 Refresh Token 저장/폐기 방식(예: DB/Redis) 중 하나를 선택해 적용한다.

#### 4.2 계좌/예수금
- **FR-ACC-001**: 사용자는 원화를 입금하여 예수금을 증가시킬 수 있어야 한다.
- **FR-ACC-002**: 사용자는 예수금/주문 가능 금액/Hold 금액을 조회할 수 있어야 한다.
- **FR-ACC-003**: 예수금 및 Hold 금액 변경은 트랜잭션으로 처리되어야 한다.
- **FR-ACC-004**: 동시 요청(주문/취소/체결)으로 인한 예수금/Hold 불일치를 방지해야 한다.  
  - MVP에서는 Redis 분산락(사용자 단위)을 사용한다.

#### 4.3 종목(Stocks)
- **FR-STK-001**: 종목 등록/조회/수정/삭제(CRUD)를 제공해야 한다.
- **FR-STK-002**: 종목 목록 조회(페이징/정렬)를 제공해야 한다.

#### 4.4 주문(Orders)
- **FR-ORD-001**: 사용자는 매수/매도 주문을 생성할 수 있어야 한다.
- **FR-ORD-002**: 주문 생성 시 기본 검증을 수행해야 한다.  
  - 매수: 주문 가능 금액 충분 여부  
  - 매도: 보유 수량 충분 여부(최소 MVP에서는 단순 검증)
- **FR-ORD-003**: **매수 주문 시 주문 금액만큼 Hold 금액이 즉시 증가(Hold)되어야 한다.**
- **FR-ORD-004**: 사용자는 주문을 조회할 수 있어야 한다(미체결/체결/취소/전체).
- **FR-ORD-005**: 사용자는 미체결 주문을 취소할 수 있어야 한다.
- **FR-ORD-006**: **주문 취소 시 해당 주문으로 Hold된 금액이 즉시 복구(Available 증가)되어야 한다.**

#### 4.5 체결(Fills)
- **FR-FIL-001**: 시스템은 주문을 체결 처리할 수 있어야 한다(최소 MVP: 단순 매칭/가상 체결 가능).
- **FR-FIL-002**: **체결 성공 시** 다음이 보장되어야 한다.
  - Hold 금액 감소(해제)
  - 예수금 실제 차감
  - 잔고(보유수량/평단) 갱신
- **FR-FIL-003**: **체결 실패(또는 주문 만료) 시** Hold 금액이 즉시 복구되어야 한다.
- **FR-FIL-004**: 사용자는 체결 내역을 조회할 수 있어야 한다.

#### 4.6 거래 로그(Logging)
- **FR-LOG-001**: **체결 성공 시 거래 로그를 남겨야 한다.**
  - MVP: MySQL에 기록(테이블로 저장)  
  - 확장: MongoDB로 이관(대량 로그/유연한 스키마)

### 5. 비기능 요구사항 (Non-Functional Requirements)

#### 5.1 성능/확장성 (MVP 목표)
- **NFR-PERF-001**: 목록/조회성 API는 P95 200ms 이하를 목표로 한다(로컬/개발환경 기준 제외).
- **NFR-PERF-002**: 주문/체결/예수금 변경 API는 불필요한 외부 호출 없이 DB+Redis 범위에서 처리한다.
- **NFR-PERF-003**: Redis 락으로 인해 전체 시스템이 병목이 되지 않도록 **락 키를 사용자 단위로 제한**한다.

#### 5.2 일관성/동시성
- **NFR-CON-001**: 예수금/Hold/주문 상태 변경은 “중복 실행”에도 안전해야 한다(멱등성 고려).
- **NFR-CON-002**: 동일 주문에 대한 체결/취소 경합 시 최종 상태가 모순되지 않아야 한다.

#### 5.3 보안
- **NFR-SEC-001**: 비밀번호는 강한 해시(예: BCrypt)로 저장해야 한다.
- **NFR-SEC-002**: 인증이 필요한 API는 인가 정책(본인 계좌/주문만 접근)을 강제해야 한다.

#### 5.4 관찰성(Observability) - MVP 최소
- **NFR-OBS-001**: 요청 단위 로그에 traceId/requestId를 포함해야 한다.
- **NFR-OBS-002**: 핵심 이벤트(입금/주문생성/취소/체결성공/실패)는 구조화 로그로 남겨야 한다.

### 6. 데이터 요구사항 (MVP)
- **DR-001**: MySQL에 다음 엔티티(또는 동등한 테이블)가 존재해야 한다.
  - users, accounts(예수금/Hold), stocks, orders, fills, holdings, trade_logs
- **DR-002**: accounts는 예수금과 Hold 금액을 분리 저장해야 한다(Available은 계산값).
- **DR-003**: orders는 상태(NEW/OPEN/CANCELLED/FILLED/FAILED/EXPIRED 등)를 가져야 한다.

### 7. 제약/가정
- **AS-001**: MVP에서는 실시간 시세/호가창/복잡한 주문유형(IOC/FOK 등)은 제외할 수 있다.
- **AS-002**: 체결 엔진은 MVP에서 단순화 가능하되, 주문 상태 전이와 예수금/Hold 정합성은 반드시 보장한다.

### 8. 확장 요구사항 (Phase 이후)
- **EX-001**: PostgreSQL 마이그레이션 및 DB 튜닝(인덱스/파티셔닝/실행계획).
- **EX-002**: MongoDB로 거래 로그(체결 상세) 저장 + TTL 인덱스 적용.
- **EX-003**: Elasticsearch로 종목 검색/자동완성 도입.
- **EX-004**: HikariCP 튜닝 및 풀 메트릭 기반 최적화.
- **EX-005**: 쓰레드 덤프 자동 수집/분석 체계(고CPU/고지연 트리거) 구축.

